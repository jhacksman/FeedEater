- name: Create install directory
  ansible.builtin.file:
    path: "{{ feedeater_root }}"
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Copy FeedEater project files (rsync)
  ansible.posix.synchronize:
    src: "{{ playbook_dir }}/../"
    dest: "{{ feedeater_root }}/"
    delete: no
    rsync_opts:
      - "--exclude=.git"
      - "--exclude=node_modules"
      - "--exclude=dist"
      - "--exclude=.next"
      - "--exclude=out"
      - "--exclude=*.log"
      - "--exclude=.env"
      - "--exclude=ansible"

- name: Read existing .env (if present)
  ansible.builtin.slurp:
    src: "{{ feedeater_root }}/.env"
  register: feedeater_env_file
  ignore_errors: true
  no_log: true

- name: Initialize feedeater_env defaults
  ansible.builtin.set_fact:
    feedeater_env: "{{ feedeater_env | default({}) }}"
  no_log: true

- name: Extract existing FEED_SETTINGS_KEY/FEED_INTERNAL_TOKEN (if present)
  ansible.builtin.set_fact:
    feedeater_existing_settings_key: >-
      {{
        (
          (
            (feedeater_env_file.content | b64decode)
            | regex_search('(?m)^FEED_SETTINGS_KEY=.*$')
            | default('')
          )
          | regex_replace('^FEED_SETTINGS_KEY=', '')
        )
        if (feedeater_env_file is defined and feedeater_env_file.content is defined)
        else ''
      }}
    feedeater_existing_internal_token: >-
      {{
        (
          (
            (feedeater_env_file.content | b64decode)
            | regex_search('(?m)^FEED_INTERNAL_TOKEN=.*$')
            | default('')
          )
          | regex_replace('^FEED_INTERNAL_TOKEN=', '')
        )
        if (feedeater_env_file is defined and feedeater_env_file.content is defined)
        else ''
      }}
  no_log: true

- name: Generate FEED_SETTINGS_KEY if missing
  ansible.builtin.command:
    cmd: python3 -c "import os,base64; print(base64.b64encode(os.urandom(32)).decode())"
  register: gen_settings_key
  changed_when: true
  when: feedeater_existing_settings_key | default('') | length == 0
  no_log: true

- name: Generate FEED_INTERNAL_TOKEN if missing
  ansible.builtin.command:
    cmd: python3 -c "import os,base64; print(base64.urlsafe_b64encode(os.urandom(32)).decode().rstrip('='))"
  register: gen_internal_token
  changed_when: true
  when: feedeater_existing_internal_token | default('') | length == 0
  no_log: true

- name: Choose FEED_SETTINGS_KEY value
  ansible.builtin.set_fact:
    feedeater_settings_key: "{{ feedeater_existing_settings_key | trim }}"
  when: feedeater_existing_settings_key | default('') | length > 0
  no_log: true

- name: Choose FEED_SETTINGS_KEY value (generated)
  ansible.builtin.set_fact:
    feedeater_settings_key: "{{ gen_settings_key.stdout | default('') | trim }}"
  when: (feedeater_settings_key is not defined) and (gen_settings_key is defined) and (gen_settings_key.stdout is defined)
  no_log: true

- name: Choose FEED_INTERNAL_TOKEN value
  ansible.builtin.set_fact:
    feedeater_internal_token: "{{ feedeater_existing_internal_token | trim }}"
  when: feedeater_existing_internal_token | default('') | length > 0
  no_log: true

- name: Choose FEED_INTERNAL_TOKEN value (generated)
  ansible.builtin.set_fact:
    feedeater_internal_token: "{{ gen_internal_token.stdout | default('') | trim }}"
  when: (feedeater_internal_token is not defined) and (gen_internal_token is defined) and (gen_internal_token.stdout is defined)
  no_log: true

- name: Merge secrets into env for rendering
  ansible.builtin.set_fact:
    feedeater_env: "{{ feedeater_env | combine({'FEED_SETTINGS_KEY': feedeater_settings_key, 'FEED_INTERNAL_TOKEN': feedeater_internal_token}, recursive=True) }}"
  no_log: true

- name: Write .env
  ansible.builtin.template:
    src: env.j2
    dest: "{{ feedeater_root }}/.env"
    owner: root
    group: docker
    mode: "0640"
  no_log: true

- name: Pull images
  ansible.builtin.command:
    chdir: "{{ feedeater_root }}"
    cmd: docker compose pull
  register: pull_result
  changed_when: "'Downloaded newer image' in pull_result.stdout or pull_result.rc == 0"

- name: Build and start services
  ansible.builtin.command:
    chdir: "{{ feedeater_root }}"
    cmd: docker compose up -d --build

- name: Apply Prisma schema (idempotent)
  ansible.builtin.command:
    chdir: "{{ feedeater_root }}"
    cmd: docker compose run --rm --workdir /app api npx prisma db push --schema packages/db/prisma/schema.prisma


